import 'dart:convert';

import 'package:boring_flutter_app/src/article.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:http/http.dart' as http;

void main() {
  test("parses topstories.json", () {
    const jsonString =
        "[26865832,26866065,26863907,26866597,26859058,26854896,26860150,26861875,26864213,26859907,26860763,26865079,26860627,26863172,26860925,26860062,26861728,26866482,26861843,26859507,26860381,26860842,26866754,26863052,26860992,26864264,26864009,26866970,26860609,26859895,26863482,26860919,26863490,26858053,26862318,26866934,26858935,26858741,26860435,26858614,26865628,26860643,26858635,26860503,26865863,26862856,26858752,26860244,26858659,26855726,26866980,26859893,26859187,26862900,26853285,26857888,26863453,26861835,26862162,26860227,26847596,26860715,26864438,26864471,26855597,26858409,26850545,26846718,26851708,26856720,26860556,26863225,26854990,26842765,26857283,26863740,26863832,26855659,26851429,26842081,26849828,26849866,26854073,26852309,26856798,26854292,26848827,26852399,26854672,26859026,26851930,26855037,26856387,26847780,26851533,26849131,26843838,26842935,26852631,26848232,26838642,26854819,26856883,26859788,26863351,26856570,26848517,26850574,26843339,26856055,26845037,26851803,26858485,26862429,26843068,26843698,26842362,26859113,26852970,26851070,26837926,26839692,26858986,26845050,26849998,26842378,26854876,26847816,26861656,26862516,26863291,26850913,26844774,26853339,26836648,26842442,26845817,26842191,26842375,26860425,26857703,26838992,26845791,26843228,26850682,26842018,26854130,26851433,26841713,26842900,26840644,26857743,26860785,26849194,26846163,26859475,26841482,26851687,26849652,26846641,26843599,26856884,26850779,26839686,26857748,26844107,26852142,26851799,26842611,26861929,26858934,26845530,26844928,26836366,26849036,26845355,26837458,26845811,26841631,26839892,26849927,26857025,26843660,26851425,26847921,26840855,26851818,26837004,26846753,26841166,26840006,26860333,26842753,26860272,26844603,26837393,26841647,26854926,26850630,26840289,26856053,26839781,26841552,26849974,26860996,26847332,26841205,26841783,26855225,26844715,26856679,26844782,26845927,26839799,26859293,26846880,26839047,26838580,26858456,26862087,26841134,26855578,26852094,26838333,26850150,26843938,26837420,26837851,26860748,26837735,26844130,26856691,26863044,26842859,26840866,26858957,26849796,26843741,26844121,26850679,26836923,26840427,26847251,26845983,26849139,26845775,26841370,26856552,26846870,26852858,26837152,26854556,26854241,26837625,26849713,26857875,26839535,26843874,26853129,26853599,26842510,26847835,26844396,26842314,26854464,26848214,26846191,26846649,26836367,26856710,26856853,26841519,26837242,26841009,26838866,26842066,26838782,26843880,26840879,26843632,26850476,26849056,26854283,26843312,26850313,26837424,26859066,26836184,26850350,26838959,26842268,26838852,26835692,26853003,26848045,26847964,26847101,26843832,26852178,26840396,26839856,26846780,26848494,26841399,26848389,26838411,26848283,26836075,26851401,26844025,26843985,26851045,26843504,26848874,26856276,26846784,26850039,26847609,26839354,26837475,26858811,26840918,26838124,26846653,26846477,26837390,26854570,26846379,26840021,26849085,26839068,26840718,26837234,26839783,26842128,26847448,26838614,26851312,26840806,26851694,26849151,26846312,26844941,26841502,26837809,26840873,26840816,26855317,26837318,26849698,26853180,26839528,26848497,26838557,26836453,26852653,26841122,26852731,26840856,26839099,26838776,26838427,26838371,26836435,26835891,26847193,26848521,26857127,26837738,26835678,26838535,26836230,26846652,26850171,26853108,26839965,26835958,26837423,26841993,26861262,26859401,26861247,26840836,26862920,26851721,26843860,26842986,26836170,26852975,26835723,26852704,26844470,26845633,26854994,26855669,26847450,26854717,26853962,26844561]";

    expect(parseTopStories(jsonString).first, 26865832);
  });

  test("parses item.json", () {
    const itemString =
        '{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8917,8952,8958,8884,8887,8869,8940,8908,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}';

    expect(parseArticle(itemString).by, "dhouston");
  });

  test("parses item.json over a network", () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final res = await http.get(url);
    if (res.statusCode == 200) {
      final idList = parseTopStories(res.body);
      if (idList.isNotEmpty) {
        final storyUrl =
            'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';
        final storyRes = await http.get(storyUrl);
        if (res.statusCode == 200) {
          expect(parseArticle(storyRes.body), isNotNull);
        }
      }
    }
  }, skip: true);
}
